#!/bin/bash

# This script runs on first boot for Raspberry Pi OS Bookworm and later
# It sets up SSH keys and configuration for the pi user

echo '====== START FIRST RUN ======'
set +xe

# Determine boot partition location
if [ -d /boot/firmware ]; then
    BOOT_DIR="/boot/firmware"
else
    BOOT_DIR="/boot"
fi

# Disable the setup wizard
#rm -f /etc/xdg/autostart/piwiz.desktop
#rm -f /etc/xdg/autostart/xdg-user-dirs.desktop

# Create NetworkManager connection file
cat << 'NMEOF' > /etc/NetworkManager/system-connections/gords.nmconnection
[connection]
id=gords
uuid={{uuid}}
type=wifi
autoconnect=true
permissions=

[wifi]
mode=infrastructure
ssid={{wifi_ssid}}

[wifi-security]
auth-alg=open
key-mgmt=wpa-psk
psk={{wifi_password}}

[ipv4]
method=auto

[ipv6]
addr-gen-mode=default
method=auto
NMEOF

# Set correct permissions for NetworkManager connection file
chmod 600 /etc/NetworkManager/system-connections/gords.nmconnection
chown root:root /etc/NetworkManager/system-connections/gords.nmconnection

# Generate locale
echo 'en_US.UTF-8 UTF-8' >/etc/locale.gen
locale-gen
localectl set-locale LANG=en_US.UTF-8

# Remove this script so it doesn't run again
sed -i 's| systemd.run.*||g' ${BOOT_DIR}/cmdline.txt
rm -f ${BOOT_DIR}/firstrun.sh

set +x
echo '====== STOP FIRST RUN ======'
exit 0
