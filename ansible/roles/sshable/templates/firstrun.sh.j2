#!/bin/bash

# This script runs on first boot for Raspberry Pi OS Bookworm and later
# It sets up SSH keys and configuration for the pi user

echo '====== START FIRST RUN ======'
set +xe

# Determine boot partition location
if [ -d /boot/firmware ]; then
    BOOT_DIR="/boot/firmware"
else
    BOOT_DIR="/boot"
fi

# Create .ssh directory
mkdir -p /home/pi/.ssh
chmod 0700 /home/pi/.ssh

# Add authorized keys
cat << 'EOF' > /home/pi/.ssh/authorized_keys
{% for key in ssh_public_keys %}
{{ key }}
{% endfor %}
EOF

# Set correct permissions
chmod 0600 /home/pi/.ssh/authorized_keys
chown -R pi:pi /home/pi/.ssh

# Disable the setup wizard
rm -f /etc/xdg/autostart/piwiz.desktop
rm -f /etc/xdg/autostart/xdg-user-dirs.desktop

# Enable wifi
rfkill unblock wlan
nmcli radio wifi on
nmcli dev wifi connect {{wifi_ssid}} password {{wifi_password}} wep-key-type key

# Generate locale
echo 'en_US.UTF-8 UTF-8' >/etc/locale.gen
locale-gen
localectl set-locale LANG=en_US.UTF-8

# Remove this script so it doesn't run again
rm -f ${BOOT_DIR}/firstrun.sh
sed -i 's| systemd.run.*||g' ${BOOT_DIR}/cmdline.txt

set +x
echo '====== STOP FIRST RUN ======'
exit 0
