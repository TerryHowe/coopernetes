---
- name: Check if boot partition exists (older OS)
  stat:
    path: '{{mount_point}}/boot'
  register: boot_partition

- name: Check if bootfs/firmware partition exists (newer OS)
  stat:
    path: '{{mount_point}}/bootfs'
  register: bootfs_partition
  when: not boot_partition.stat.exists

- name: Set boot path for older OS
  set_fact:
    boot_path: '{{mount_point}}/boot'
  when: boot_partition.stat.exists

- name: Set boot path for newer OS
  set_fact:
    boot_path: '{{mount_point}}/bootfs'
  when: not boot_partition.stat.exists and bootfs_partition.stat.exists

- name: enable ssh (creates empty ssh file)
  copy:
    content: ''
    dest: '{{ boot_path }}/ssh'
    force: no
    mode: 0755
  become: yes

- name: wifi credentials
  copy:
    src: wpa_supplicant.conf
    dest: '{{ boot_path }}/wpa_supplicant.conf'
    mode: 0600
  become: yes
  when: boot_path is defined

- name: Check if pi user home directory exists
  stat:
    path: '{{mount_point}}/rootfs/home/pi'
  register: pi_user_home

- name: Create userconf.txt for newer OS (if pi user doesn't exist)
  copy:
    content: 'pi:{{ pi_user_password_hash }}'
    dest: '{{ boot_path }}/userconf.txt'
    mode: 0600
  become: yes
  when: boot_path is defined and not pi_user_home.stat.exists and pi_user_password_hash is defined

- name: Create ssh directory
  file:
    path: '{{mount_point}}/rootfs/home/pi/.ssh'
    state: directory
    owner: pi
    group: pi
    mode: 0700
  when: pi_user_home.stat.exists

- name: copy over ssh public keys
  authorized_key:
    key: '{{item}}'
    path: '{{mount_point}}/rootfs/home/pi/.ssh/authorized_keys'
    user: pi
  loop: '{{ssh_public_keys}}'
  when: pi_user_home.stat.exists

- name: Disable setup wizzard for desktop version
  file:
    path: '{{mount_point}}/rootfs/etc/xdg/autostart/piwiz.desktop'
    state: absent
  become: yes

- name: Unmount boot
  ansible.posix.mount:
    path: /media/pi/boot
    state: unmounted
  become: yes

- name: Unmount root
  ansible.posix.mount:
    path: /media/pi/rootfs
    state: unmounted
  become: yes
