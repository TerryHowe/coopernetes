---
- name: Check for kernel args
  shell: cat /boot/firmware/cmdline.txt | grep -c '{{kernel_args}}' || true
  register: cmdline_grep
  changed_when: False

- name: Add /boot/firmware/cmdline.txt kernel args
  replace:
    path: /boot/firmware/cmdline.txt
    regexp: '^(.+)$'
    replace: '\1 {{kernel_args}}'
  become: yes
  register: kernel_args
  when: cmdline_grep.stdout == "0"

- name: Configure sysctl for Kubernetes networking
  copy:
    content: |
      # Kubernetes networking requirements
      net.ipv4.ip_forward = 1
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
    dest: /etc/sysctl.d/99-kubernetes.conf
    mode: '0644'
  become: yes
  register: sysctl_config

- name: Load br_netfilter module
  modprobe:
    name: br_netfilter
    state: present
  become: yes
  failed_when: False

- name: Ensure br_netfilter loads on boot
  lineinfile:
    path: /etc/modules-load.d/k8s.conf
    line: br_netfilter
    create: yes
    mode: '0644'
  become: yes

- name: Apply sysctl settings
  command: sysctl --system
  become: yes
  when: sysctl_config is changed

- name: Check swap settings
  command: swapon --show
  become: yes
  register: swapon
  changed_when: False

- name: Check if dphys-swapfile exists
  command: which dphys-swapfile
  register: dphys_swapfile_check
  changed_when: False
  failed_when: False

- name: Turn off swap if needed (using dphys-swapfile)
  block:
    - name: Turn swap off
      command: dphys-swapfile swapoff
      become: yes

    - name: Stop swap service
      systemd:
        name: dphys-swapfile
        state: stopped
        enabled: no
      become: yes

    - name: Remove swap file
      command: dphys-swapfile uninstall
      args:
        removes: /var/swap
      become: yes

    - name: Remove dphys-swapfile
      apt:
        name: dphys-swapfile
        state: absent
        purge: yes
      become: yes
  when: swapon.stdout != "" and dphys_swapfile_check.rc == 0

- name: Turn off swap if needed (generic method)
  block:
    - name: Disable all swap
      command: swapoff -a
      become: yes

    - name: Remove swap entries from /etc/fstab
      lineinfile:
        path: /etc/fstab
        regexp: '^[^#].*\s+swap\s+'
        state: absent
      become: yes

    - name: Disable zram-swap service if present
      systemd:
        name: zram-swap
        state: stopped
        enabled: no
      become: yes
      failed_when: False

    - name: Stop and mask dev-zram0.swap (rpi-swap mechanism)
      systemd:
        name: dev-zram0.swap
        state: stopped
        enabled: no
        masked: yes
      become: yes
      failed_when: False

    - name: Disable rpi-swap by renaming config file
      command: mv /etc/rpi/swap.conf /etc/rpi/swap.conf.disabled
      args:
        removes: /etc/rpi/swap.conf
      become: yes
      failed_when: False

    - name: Remove common swap files
      file:
        path: "{{ item }}"
        state: absent
      become: yes
      loop:
        - /var/swap
        - /swap
        - /swapfile
      failed_when: False
  when: swapon.stdout != "" and dphys_swapfile_check.rc != 0

- name: Reboot if needed
  ansible.builtin.include_tasks:
    file: reboot.yml
  when: kernel_args is changed or swapon.stdout != ""

- name: Check that the crictl executable exists
  stat:
    path: /usr/bin/crictl
  register: crictl_executable

- name: Install containerd if needed
  block:
    - name: Install prerequisites for Docker repository
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - open-iscsi
        state: present
        update_cache: yes
      become: yes

    - name: Create keyrings directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      become: yes

    - name: Add Docker GPG key
      shell: |
        curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg
      become: yes

    - name: Get OS codename
      shell: . /etc/os-release && echo "$VERSION_CODENAME"
      register: os_codename
      changed_when: False

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=arm64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian {{ os_codename.stdout }} stable"
        state: present
        filename: docker
      become: yes

    - name: Install containerd.io
      apt:
        name: containerd.io
        state: present
        update_cache: yes
      become: yes

    - name: Create containerd config directory
      file:
        path: /etc/containerd
        state: directory
        mode: '0755'
      become: yes

    - name: Generate default containerd config
      shell: containerd config default > /etc/containerd/config.toml
      args:
        creates: /etc/containerd/config.toml
      become: yes

    - name: Ensure containerd is running
      systemd:
        name: containerd
        state: started
        enabled: yes
      become: yes
  when: not crictl_executable.stat.exists

- name: Check if containerd config exists
  stat:
    path: /etc/containerd/config.toml
  register: containerd_config_file
  become: yes

- name: Enable CRI plugin in containerd
  lineinfile:
    path: /etc/containerd/config.toml
    regexp: '^disabled_plugins\s*=\s*\["cri"\]'
    line: '#disabled_plugins = ["cri"]'
  become: yes
  register: containerd_cri_enabled
  when: containerd_config_file.stat.exists

- name: Configure containerd to use systemd cgroup driver
  lineinfile:
    path: /etc/containerd/config.toml
    regexp: '^\s*SystemdCgroup\s*='
    line: '            SystemdCgroup = true'
    insertafter: '^\s*\[plugins\."io\.containerd\.grpc\.v1\.cri"\.containerd\.runtimes\.runc\.options\]'
  become: yes
  register: containerd_cgroup_config
  when: containerd_config_file.stat.exists

- name: Restart containerd if config changed outside install block
  systemd:
    name: containerd
    state: restarted
    enabled: yes
  become: yes
  when: (containerd_cri_enabled is defined and containerd_cri_enabled is changed) or (containerd_cgroup_config is defined and containerd_cgroup_config is changed)

- name: Configure crictl to use containerd
  copy:
    content: |
      runtime-endpoint: unix:///run/containerd/containerd.sock
      image-endpoint: unix:///run/containerd/containerd.sock
      timeout: 10
    dest: /etc/crictl.yaml
    mode: '0644'
  become: yes

- name: Add root group to pi for containerd
  user:
    name: pi
    groups: root
    append: yes
  become: yes
